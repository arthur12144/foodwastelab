<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fresh Inventory Simulator | Fresh Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: #f8f9fa;
      padding: 20px;
      color: #333;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { text-align: center; font-size: 28px; margin-bottom: 5px; }
    .subtitle { text-align: center; color: #666; margin-bottom: 25px; }
    
    .hero-metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    @media (max-width: 768px) { .hero-metrics { grid-template-columns: 1fr; } }
    
    .hero-box {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-top: 4px solid #ccc;
    }
    .hero-box.green { border-top-color: #16a34a; }
    .hero-box.blue { border-top-color: #2563eb; }
    .hero-box.red { border-top-color: #dc2626; }
    .hero-box .value { font-size: 48px; font-weight: bold; }
    .hero-box.green .value { color: #16a34a; }
    .hero-box.blue .value { color: #2563eb; }
    .hero-box.red .value { color: #dc2626; }
    .hero-box .label { font-size: 14px; color: #666; margin-top: 5px; }
    .hero-box .sublabel { font-size: 11px; color: #999; margin-top: 3px; }
    
    .controls { 
      display: grid; 
      grid-template-columns: 1fr 1fr 1fr; 
      gap: 20px; 
      margin-bottom: 30px; 
    }
    @media (max-width: 900px) { .controls { grid-template-columns: 1fr; } }
    
    .control-box { 
      background: #fff; 
      padding: 20px; 
      border-radius: 10px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    }
    .control-box h3 { margin-bottom: 15px; font-size: 16px; }
    .slider-group { margin-bottom: 15px; }
    .slider-group:last-child { margin-bottom: 0; }
    .slider-group label { display: block; margin-bottom: 5px; font-size: 13px; }
    .slider-group label strong { color: #2563eb; }
    .slider-group input[type="range"] { 
      width: 100%; 
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: #e5e7eb;
      border-radius: 4px;
      outline: none;
    }
    .slider-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #3b82f6;
      border-radius: 50%;
      cursor: pointer;
    }
    .slider-group input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #3b82f6;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }
    .slider-group.highlight input[type="range"]::-webkit-slider-thumb { background: #7c3aed; }
    .slider-group.highlight input[type="range"]::-moz-range-thumb { background: #7c3aed; }
    .slider-group.highlight label strong { color: #7c3aed; }
    .slider-labels { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-top: 3px; }
    
    .rotation-btn {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #d1d5db;
      background: #fff;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rotation-btn:hover { border-color: #7c3aed; }
    .rotation-btn.active { 
      background: #7c3aed; 
      color: #fff; 
      border-color: #7c3aed; 
    }
    
    .derived-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 25px;
    }
    @media (max-width: 768px) { .derived-stats { grid-template-columns: repeat(2, 1fr); } }
    
    .derived-box {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .derived-box .value { font-size: 20px; font-weight: bold; color: #374151; }
    .derived-box .label { font-size: 11px; color: #666; margin-top: 3px; }
    
    .charts { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 20px; 
      margin-bottom: 25px; 
    }
    @media (max-width: 768px) { .charts { grid-template-columns: 1fr; } }
    
    .chart-box { 
      background: #fff; 
      padding: 20px; 
      border-radius: 10px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    }
    .chart-box h3 { font-size: 14px; margin-bottom: 5px; }
    .chart-box .chart-subtitle { font-size: 11px; color: #888; margin-bottom: 10px; }
    .chart-container { position: relative; height: 180px; }
    
    .tradeoff-box {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .tradeoff-box h3 { color: #92400e; margin-bottom: 10px; }
    .tradeoff-box p { font-size: 14px; line-height: 1.6; color: #78350f; }
    .tradeoff-box .formula { 
      background: rgba(255,255,255,0.6); 
      padding: 10px 15px; 
      border-radius: 6px; 
      margin-top: 10px;
      font-family: monospace;
      font-size: 13px;
    }
    
    .insight-box { 
      background: #eff6ff; 
      border: 1px solid #bfdbfe; 
      padding: 20px; 
      border-radius: 10px; 
      margin-bottom: 20px; 
    }
    .insight-box h3 { color: #1e40af; margin-bottom: 10px; }
    .insight-box p { font-size: 14px; line-height: 1.6; }
    
    .scenarios { 
      background: #fff; 
      padding: 20px; 
      border-radius: 10px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      margin-bottom: 20px; 
    }
    .scenarios h3 { margin-bottom: 10px; }
    .scenarios ul { list-style: none; font-size: 13px; }
    .scenarios li { padding: 5px 0; }
    
    .footer { text-align: center; font-size: 11px; color: #888; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Fresh Inventory Simulator</h1>
    <p class="subtitle">Explore the trade-off between service level, shrink, and customer freshness</p>
    
    <!-- Hero Metrics -->
    <div class="hero-metrics">
      <div class="hero-box green">
        <div class="value" id="heroInstock">95.0%</div>
        <div class="label">In-Stock Rate</div>
        <div class="sublabel">% of demand fulfilled</div>
      </div>
      <div class="hero-box blue">
        <div class="value" id="heroFreshness">3.5</div>
        <div class="label">Customer Days of Freshness</div>
        <div class="sublabel">avg shelf life at purchase</div>
      </div>
      <div class="hero-box red">
        <div class="value" id="heroShrink">13.5%</div>
        <div class="label">Shrink Rate</div>
        <div class="sublabel">% of units wasted</div>
      </div>
    </div>
    
    <!-- Controls -->
    <div class="controls">
      <div class="control-box">
        <h3>üì¶ Shelf Life at Store Receipt</h3>
        <div class="slider-group">
          <label>Mean: <strong id="slMeanLabel">8.5 days</strong></label>
          <input type="range" id="slMean" min="4" max="14" step="0.5" value="8.5">
          <div class="slider-labels"><span>4 days</span><span>14 days</span></div>
        </div>
        <div class="slider-group">
          <label>Variability (Std Dev): <strong id="slStdLabel">2.0 days</strong></label>
          <input type="range" id="slStd" min="0.5" max="4" step="0.25" value="2">
          <div class="slider-labels"><span>0.5 (consistent)</span><span>4.0 (variable)</span></div>
        </div>
      </div>
      
      <div class="control-box">
        <h3>üõí Demand & Replenishment</h3>
        <div class="slider-group">
          <label>Delivery Frequency: <strong id="baseDaysLabel">3x per week</strong></label>
          <input type="range" id="deliveryFreq" min="2" max="7" step="1" value="3">
          <div class="slider-labels"><span>2x/week (less frequent)</span><span>7x/week (daily)</span></div>
        </div>
        <div class="slider-group">
          <label>Demand Variability (CV): <strong id="demandCVLabel">0.50</strong></label>
          <input type="range" id="demandCV" min="0.2" max="0.8" step="0.05" value="0.5">
          <div class="slider-labels"><span>0.2 (stable)</span><span>0.8 (volatile)</span></div>
        </div>
      </div>
      
      <div class="control-box" style="background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);">
        <h3>üéØ Inventory Policy</h3>
        <div class="slider-group highlight">
          <label>Service Level Target: <strong id="serviceLevelLabel">95%</strong></label>
          <input type="range" id="serviceLevel" min="50" max="99" step="1" value="95">
          <div class="slider-labels"><span>50% (lean)</span><span>99% (buffer)</span></div>
        </div>
        <div style="margin-top: 15px;">
          <label style="display: block; font-size: 13px; margin-bottom: 8px;">Shelf Rotation Practice:</label>
          <div style="display: flex; gap: 8px;">
            <button type="button" id="btnFIFO" class="rotation-btn active" onclick="setRotation('FIFO')">FIFO</button>
            <button type="button" id="btnMixed" class="rotation-btn" onclick="setRotation('Mixed')">50/50</button>
            <button type="button" id="btnLIFO" class="rotation-btn" onclick="setRotation('LIFO')">LIFO</button>
          </div>
          <div style="font-size: 11px; color: #666; margin-top: 6px;" id="rotationDesc">Oldest stock sells first (best practice)</div>
        </div>
        <div style="margin-top: 12px; padding: 10px; background: rgba(124,58,237,0.1); border-radius: 6px;">
          <div style="font-size: 12px; color: #5b21b6;">
            Implied Days of Cover: <strong id="impliedDOC">4.2</strong>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Derived Stats -->
    <div class="derived-stats">
      <div class="derived-box">
        <div class="value" id="statDOC">4.2</div>
        <div class="label">Total Days of Cover</div>
      </div>
      <div class="derived-box">
        <div class="value" id="statAvgDwell">2.1</div>
        <div class="label">Avg Dwell Time (days)</div>
      </div>
      <div class="derived-box">
        <div class="value" id="statUnitsLost">1,350</div>
        <div class="label">Units Shrunk (per 10k)</div>
      </div>
      <div class="derived-box">
        <div class="value" id="statDaysShort">2.1</div>
        <div class="label">Avg Days Short (shrink)</div>
      </div>
    </div>
    
    <!-- Charts -->
    <div class="charts">
      <div class="chart-box">
        <h3>Shelf Life Distribution at Receipt</h3>
        <p class="chart-subtitle" id="slSubtitle">P20: 6.8d | Mean: 8.5d | P80: 10.2d</p>
        <div class="chart-container"><canvas id="chartShelfLife"></canvas></div>
      </div>
      <div class="chart-box">
        <h3>Customer Freshness Distribution</h3>
        <p class="chart-subtitle" id="freshSubtitle">Days of shelf life remaining at purchase</p>
        <div class="chart-container"><canvas id="chartFreshness"></canvas></div>
      </div>
      <div class="chart-box">
        <h3>Shrink Rate by Shelf Life at Receipt</h3>
        <p class="chart-subtitle" id="shrinkBySlSubtitle">Which inbound batches are highest risk?</p>
        <div class="chart-container"><canvas id="chartShrinkBySL"></canvas></div>
      </div>
      <div class="chart-box">
        <h3>Service Level Trade-off Curve</h3>
        <p class="chart-subtitle">Shrink % at different service levels</p>
        <div class="chart-container"><canvas id="chartTradeoff"></canvas></div>
      </div>
    </div>
    
    <!-- Trade-off Box -->
    <div class="tradeoff-box">
      <h3>‚öñÔ∏è The Core Trade-off</h3>
      <p>
        Higher service level ‚Üí more safety stock ‚Üí longer dwell time ‚Üí more shrink but fewer stockouts.<br>
        Your current policy: <strong id="tradeoffSummary">95% service level costs 13.5% shrink to achieve.</strong>
      </p>
      <div class="formula">
        Days of Cover = (7 √∑ Deliveries per Week) √ó (1 + z<sub>service level</sub> √ó Demand CV)
      </div>
    </div>
    
    <!-- Insight Box -->
    <div class="insight-box">
      <h3>üí° Key Insight</h3>
      <p id="insightText">
        At 95% service level with 8.5-day shelf life at receipt, you're holding ~4.2 days of cover. 
        Average dwell time is ~2.1 days, leaving customers with 3.5 days of freshness on average.
        13.5% of units don't make it. To cut shrink in half, either get product 2 days fresher OR accept 85% service level.
      </p>
    </div>
    
    <!-- Scenarios -->
    <div class="scenarios">
      <h3>üß™ Scenarios to Explore</h3>
      <ul>
        <li>‚Ä¢ <strong>Baseline:</strong> 95% SL, 8.5d shelf life, 3x/week, FIFO ‚Üí ~13% shrink</li>
        <li>‚Ä¢ <strong>Fresher supply:</strong> Increase shelf life to 10.5d ‚Üí shrink drops to ~5%</li>
        <li>‚Ä¢ <strong>Accept more stockouts:</strong> Drop to 85% SL ‚Üí shrink drops to ~6%</li>
        <li>‚Ä¢ <strong>Daily delivery:</strong> Switch to 7x/week ‚Üí shrink drops dramatically</li>
        <li>‚Ä¢ <strong>Poor rotation:</strong> Switch to LIFO ‚Üí shrink increases, freshness becomes bimodal (most good, some very stale)</li>
        <li>‚Ä¢ <strong>Real-world rotation:</strong> Try 50/50 mix ‚Äî reflects actual store behavior</li>
      </ul>
    </div>
    
    <p class="footer">Fresh Analytics | Simulation: 10,000 units per run | Model assumes FIFO inventory rotation</p>
  </div>

  <script>
    // ============================================
    // MATH UTILITIES
    // ============================================
    
    function mulberry32(a) {
      return function() {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }

    function randomNormal(mean, std, rand) {
      const u1 = rand();
      const u2 = rand();
      const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
      return mean + std * z;
    }

    function randomGamma(shape, scale, rand) {
      if (shape < 1) {
        return randomGamma(shape + 1, scale, rand) * Math.pow(rand(), 1 / shape);
      }
      const d = shape - 1/3;
      const c = 1 / Math.sqrt(9 * d);
      while (true) {
        let x, v;
        do {
          x = randomNormal(0, 1, rand);
          v = 1 + c * x;
        } while (v <= 0);
        v = v * v * v;
        const u = rand();
        if (u < 1 - 0.0331 * (x * x) * (x * x)) return d * v * scale;
        if (Math.log(u) < 0.5 * x * x + d * (1 - v + Math.log(v))) return d * v * scale;
      }
    }

    // Approximate inverse normal CDF (Abramowitz and Stegun approximation)
    function normInv(p) {
      if (p <= 0) return -Infinity;
      if (p >= 1) return Infinity;
      if (p === 0.5) return 0;
      
      const a1 = -3.969683028665376e+01;
      const a2 = 2.209460984245205e+02;
      const a3 = -2.759285104469687e+02;
      const a4 = 1.383577518672690e+02;
      const a5 = -3.066479806614716e+01;
      const a6 = 2.506628277459239e+00;
      
      const b1 = -5.447609879822406e+01;
      const b2 = 1.615858368580409e+02;
      const b3 = -1.556989798598866e+02;
      const b4 = 6.680131188771972e+01;
      const b5 = -1.328068155288572e+01;
      
      const c1 = -7.784894002430293e-03;
      const c2 = -3.223964580411365e-01;
      const c3 = -2.400758277161838e+00;
      const c4 = -2.549732539343734e+00;
      const c5 = 4.374664141464968e+00;
      const c6 = 2.938163982698783e+00;
      
      const d1 = 7.784695709041462e-03;
      const d2 = 3.224671290700398e-01;
      const d3 = 2.445134137142996e+00;
      const d4 = 3.754408661907416e+00;
      
      const pLow = 0.02425;
      const pHigh = 1 - pLow;
      let q, r;
      
      if (p < pLow) {
        q = Math.sqrt(-2 * Math.log(p));
        return (((((c1*q+c2)*q+c3)*q+c4)*q+c5)*q+c6) / ((((d1*q+d2)*q+d3)*q+d4)*q+1);
      } else if (p <= pHigh) {
        q = p - 0.5;
        r = q * q;
        return (((((a1*r+a2)*r+a3)*r+a4)*r+a5)*r+a6)*q / (((((b1*r+b2)*r+b3)*r+b4)*r+b5)*r+1);
      } else {
        q = Math.sqrt(-2 * Math.log(1 - p));
        return -(((((c1*q+c2)*q+c3)*q+c4)*q+c5)*q+c6) / ((((d1*q+d2)*q+d3)*q+d4)*q+1);
      }
    }

    function percentile(arr, p) {
      const sorted = [...arr].sort((a, b) => a - b);
      const idx = Math.floor(sorted.length * p / 100);
      return sorted[Math.min(idx, sorted.length - 1)];
    }

    function createHistogram(data, min, max, binSize) {
      const bins = [];
      const labels = [];
      for (let i = min; i < max; i += binSize) {
        bins.push(0);
        labels.push((i + binSize/2).toFixed(1));
      }
      data.forEach(val => {
        const binIdx = Math.floor((val - min) / binSize);
        if (binIdx >= 0 && binIdx < bins.length) {
          bins[binIdx]++;
        }
      });
      // Convert to percentages
      const total = data.length;
      const pctBins = bins.map(b => total > 0 ? (b / total) * 100 : 0);
      return { bins: pctBins, labels };
    }

    // ============================================
    // CHART INSTANCES
    // ============================================
    
    let chartShelfLife, chartFreshness, chartShrinkBySL, chartTradeoff;
    let rotationPolicy = 'FIFO'; // 'FIFO', 'LIFO', or 'Mixed'
    
    function setRotation(policy) {
      rotationPolicy = policy;
      
      // Update button states
      document.getElementById('btnFIFO').classList.remove('active');
      document.getElementById('btnMixed').classList.remove('active');
      document.getElementById('btnLIFO').classList.remove('active');
      document.getElementById('btn' + policy).classList.add('active');
      
      // Update description
      const descriptions = {
        'FIFO': 'Oldest stock sells first (best practice)',
        'Mixed': 'Partial rotation ‚Äî some old stock gets buried',
        'LIFO': 'Newest stock sells first (poor rotation)'
      };
      document.getElementById('rotationDesc').textContent = descriptions[policy];
      
      runSimulation();
    }

    // ============================================
    // MAIN SIMULATION
    // ============================================
    
    function runSimulation() {
      // Get inputs
      const slMean = parseFloat(document.getElementById('slMean').value);
      const slStd = parseFloat(document.getElementById('slStd').value);
      const deliveryFreq = parseFloat(document.getElementById('deliveryFreq').value);
      const demandCV = parseFloat(document.getElementById('demandCV').value);
      const serviceLevel = parseFloat(document.getElementById('serviceLevel').value) / 100;

      // Convert delivery frequency (times per week) to base days of cover
      const baseDays = 7 / deliveryFreq;

      // Update input labels
      document.getElementById('slMeanLabel').textContent = slMean.toFixed(1) + ' days';
      document.getElementById('slStdLabel').textContent = slStd.toFixed(1) + ' days';
      if (deliveryFreq === 7) {
        document.getElementById('baseDaysLabel').textContent = 'daily';
      } else {
        document.getElementById('baseDaysLabel').textContent = deliveryFreq.toFixed(0) + 'x per week';
      }
      document.getElementById('demandCVLabel').textContent = demandCV.toFixed(2);
      document.getElementById('serviceLevelLabel').textContent = (serviceLevel * 100).toFixed(0) + '%';

      // Calculate derived values
      const zScore = normInv(serviceLevel);
      const safetyStockFactor = Math.max(0, zScore) * demandCV;
      const daysOfCover = baseDays * (1 + safetyStockFactor);

      document.getElementById('impliedDOC').textContent = daysOfCover.toFixed(1);
      document.getElementById('statDOC').textContent = daysOfCover.toFixed(1);

      // Run Monte Carlo
      const nSim = 10000;
      const rand = mulberry32(42);

      const shelfLifeData = [];
      const freshnessData = [];
      const dwellTimeData = [];
      
      // Track shrink by shelf life bucket
      const slBuckets = {};
      const slBucketRanges = [[0,4], [4,5], [5,6], [6,7], [7,8], [8,9], [9,10], [10,11], [11,12], [12,14], [14,20]];
      slBucketRanges.forEach(r => {
        slBuckets[r[0] + '-' + r[1]] = { total: 0, shrink: 0 };
      });
      
      let shrinkCount = 0;
      let totalDaysShort = 0;
      let totalFreshness = 0;
      let soldCount = 0;

      for (let i = 0; i < nSim; i++) {
        // Shelf life at receipt (normal distribution)
        const shelfLife = Math.max(1, randomNormal(slMean, slStd, rand));
        shelfLifeData.push(shelfLife);

        // Dwell time: how long unit sits before sale
        // Model varies by rotation policy
        const dwellTime = calcDwellTime(rand, daysOfCover);
        dwellTimeData.push(dwellTime);

        const buffer = shelfLife - dwellTime;
        const shrinks = buffer < 0;
        
        // Track by bucket
        for (const r of slBucketRanges) {
          if (shelfLife >= r[0] && shelfLife < r[1]) {
            slBuckets[r[0] + '-' + r[1]].total++;
            if (shrinks) slBuckets[r[0] + '-' + r[1]].shrink++;
            break;
          }
        }

        if (shrinks) {
          // Unit shrinks (expires before sale)
          shrinkCount++;
          totalDaysShort += -buffer;
        } else {
          // Unit sells
          soldCount++;
          freshnessData.push(buffer);
          totalFreshness += buffer;
        }
      }

      const shrinkPct = (shrinkCount / nSim) * 100;
      const avgDaysShort = shrinkCount > 0 ? totalDaysShort / shrinkCount : 0;
      const avgFreshness = soldCount > 0 ? totalFreshness / soldCount : 0;
      const avgDwellTime = dwellTimeData.reduce((a, b) => a + b, 0) / dwellTimeData.length;
      const instockRate = serviceLevel * 100; // By definition of service level

      // Update hero metrics
      document.getElementById('heroInstock').textContent = instockRate.toFixed(1) + '%';
      document.getElementById('heroFreshness').textContent = avgFreshness.toFixed(1);
      document.getElementById('heroShrink').textContent = shrinkPct.toFixed(1) + '%';

      // Color-code shrink
      const shrinkEl = document.getElementById('heroShrink');
      if (shrinkPct > 20) {
        shrinkEl.style.color = '#dc2626';
      } else if (shrinkPct > 10) {
        shrinkEl.style.color = '#f59e0b';
      } else {
        shrinkEl.style.color = '#16a34a';
      }

      // Update derived stats
      document.getElementById('statAvgDwell').textContent = avgDwellTime.toFixed(1);
      document.getElementById('statUnitsLost').textContent = shrinkCount.toLocaleString();
      document.getElementById('statDaysShort').textContent = avgDaysShort.toFixed(1);

      // Update subtitles
      document.getElementById('slSubtitle').textContent = 
        'P20: ' + percentile(shelfLifeData, 20).toFixed(1) + 'd | Mean: ' + slMean.toFixed(1) + 'd | P80: ' + percentile(shelfLifeData, 80).toFixed(1) + 'd';
      document.getElementById('freshSubtitle').textContent = 
        'Mean: ' + avgFreshness.toFixed(1) + 'd | P20: ' + (freshnessData.length > 0 ? percentile(freshnessData, 20).toFixed(1) : '0') + 'd remaining';
      document.getElementById('shrinkBySlSubtitle').textContent = 
        'Shrink rate varies by inbound freshness ‚Äî shorter shelf life = higher risk';

      // Update trade-off summary
      document.getElementById('tradeoffSummary').textContent = 
        (serviceLevel * 100).toFixed(0) + '% service level costs ' + shrinkPct.toFixed(1) + '% shrink to achieve ' + avgFreshness.toFixed(1) + ' days customer freshness.';

      // Update insight text
      const freqText = deliveryFreq === 7 ? 'daily delivery' : deliveryFreq + 'x/week delivery';
      const rotationText = rotationPolicy === 'FIFO' ? 'FIFO rotation' : rotationPolicy === 'LIFO' ? 'LIFO rotation' : 'mixed rotation';
      document.getElementById('insightText').textContent = 
        'At ' + (serviceLevel * 100).toFixed(0) + '% service level with ' + slMean.toFixed(1) + '-day shelf life, ' +
        freqText + ', and ' + rotationText + ', you\'re holding ~' + 
        daysOfCover.toFixed(1) + ' days of cover. ' + shrinkPct.toFixed(1) + '% of units shrink, leaving customers with ' + 
        avgFreshness.toFixed(1) + ' days of freshness on average.';

      // Create histograms (now in percentages)
      const slHist = createHistogram(shelfLifeData, 0, 18, 1);
      const freshHist = createHistogram(freshnessData, 0, 14, 1);

      // Update Chart 1: Shelf life at receipt
      chartShelfLife.data.labels = slHist.labels;
      chartShelfLife.data.datasets[0].data = slHist.bins;
      chartShelfLife.data.datasets[0].backgroundColor = slHist.labels.map(l => {
        const v = parseFloat(l);
        if (v < 5) return '#ff6b6b';
        if (v < 8) return '#ffd93d';
        return '#6bcb77';
      });
      chartShelfLife.update();

      // Update Chart 2: Customer freshness
      chartFreshness.data.labels = freshHist.labels;
      chartFreshness.data.datasets[0].data = freshHist.bins;
      chartFreshness.data.datasets[0].backgroundColor = freshHist.labels.map(l => {
        const v = parseFloat(l);
        if (v < 3) return '#ff6b6b';
        if (v < 6) return '#ffd93d';
        return '#6bcb77';
      });
      chartFreshness.update();

      // Update Chart 3: Shrink rate by shelf life bucket
      const shrinkBySLLabels = [];
      const shrinkBySLData = [];
      const shrinkBySLColors = [];
      slBucketRanges.forEach(r => {
        const key = r[0] + '-' + r[1];
        const bucket = slBuckets[key];
        if (bucket.total > 10) { // Only show buckets with meaningful data
          shrinkBySLLabels.push(r[0] + '-' + r[1] + 'd');
          const rate = (bucket.shrink / bucket.total) * 100;
          shrinkBySLData.push(rate);
          shrinkBySLColors.push(rate > 30 ? '#ff6b6b' : rate > 15 ? '#ffd93d' : '#6bcb77');
        }
      });
      chartShrinkBySL.data.labels = shrinkBySLLabels;
      chartShrinkBySL.data.datasets[0].data = shrinkBySLData;
      chartShrinkBySL.data.datasets[0].backgroundColor = shrinkBySLColors;
      chartShrinkBySL.update();

      // Update Chart 4: Trade-off curve (pre-calculate for different service levels)
      updateTradeoffCurve(slMean, slStd, baseDays, demandCV, serviceLevel);
    }

    function updateTradeoffCurve(slMean, slStd, baseDays, demandCV, currentSL) {
      const serviceLevels = [0.50, 0.60, 0.70, 0.80, 0.85, 0.90, 0.95, 0.97, 0.99];
      const shrinkRates = [];
      const labels = serviceLevels.map(sl => (sl * 100).toFixed(0) + '%');
      
      const nSim = 3000; // Fewer for speed

      serviceLevels.forEach(sl => {
        const rand = mulberry32(42);
        const zScore = normInv(sl);
        const safetyStockFactor = Math.max(0, zScore) * demandCV;
        const daysOfCover = baseDays * (1 + safetyStockFactor);

        let shrinkCount = 0;
        for (let i = 0; i < nSim; i++) {
          const shelfLife = Math.max(1, randomNormal(slMean, slStd, rand));
          const dwellTime = calcDwellTime(rand, daysOfCover);
          if (shelfLife - dwellTime < 0) shrinkCount++;
        }
        shrinkRates.push((shrinkCount / nSim) * 100);
      });

      chartTradeoff.data.labels = labels;
      chartTradeoff.data.datasets[0].data = shrinkRates;
      
      // Highlight current service level
      const currentIdx = serviceLevels.findIndex(sl => Math.abs(sl - currentSL) < 0.03);
      chartTradeoff.data.datasets[0].pointBackgroundColor = labels.map((_, i) => 
        i === currentIdx ? '#7c3aed' : '#ef4444'
      );
      chartTradeoff.data.datasets[0].pointRadius = labels.map((_, i) => 
        i === currentIdx ? 8 : 4
      );
      
      chartTradeoff.update();
    }
    
    // Helper function to calculate dwell time based on rotation policy
    function calcDwellTime(rand, daysOfCover) {
      let dwellTime;
      
      if (rotationPolicy === 'FIFO') {
        // FIFO: uniform distribution ‚Äî every unit waits its turn
        dwellTime = rand() * daysOfCover * 1.2;
      } else if (rotationPolicy === 'LIFO') {
        // LIFO: bimodal ‚Äî most sell fast, some get buried
        if (rand() < 0.65) {
          dwellTime = -Math.log(1 - rand()) * (daysOfCover * 0.3);
        } else {
          dwellTime = -Math.log(1 - rand()) * (daysOfCover * 2.0);
        }
      } else {
        // Mixed: 50% FIFO, 50% LIFO behavior
        if (rand() < 0.5) {
          dwellTime = rand() * daysOfCover * 1.2;
        } else {
          if (rand() < 0.65) {
            dwellTime = -Math.log(1 - rand()) * (daysOfCover * 0.3);
          } else {
            dwellTime = -Math.log(1 - rand()) * (daysOfCover * 2.0);
          }
        }
      }
      return Math.max(0, dwellTime);
    }

    // ============================================
    // INITIALIZE CHARTS
    // ============================================
    
    function initCharts() {
      chartShelfLife = new Chart(document.getElementById('chartShelfLife'), {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{ data: [], backgroundColor: '#6bcb77', borderWidth: 0 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: '#eee' }, title: { display: true, text: '% of Units' } },
            x: { grid: { color: '#eee' }, title: { display: true, text: 'Days of Shelf Life' } }
          }
        }
      });

      chartFreshness = new Chart(document.getElementById('chartFreshness'), {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{ data: [], backgroundColor: '#6bcb77', borderWidth: 0 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: '#eee' }, title: { display: true, text: '% of Units' } },
            x: { grid: { color: '#eee' }, title: { display: true, text: 'Days of Freshness' } }
          }
        }
      });

      chartShrinkBySL = new Chart(document.getElementById('chartShrinkBySL'), {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{ data: [], backgroundColor: '#ff6b6b', borderWidth: 0 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: '#eee' }, title: { display: true, text: 'Shrink Rate (%)' }, max: 100 },
            x: { grid: { color: '#eee' }, title: { display: true, text: 'Shelf Life at Receipt' } }
          }
        }
      });

      chartTradeoff = new Chart(document.getElementById('chartTradeoff'), {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Shrink Rate',
            data: [],
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            fill: true,
            tension: 0.3,
            pointBackgroundColor: '#ef4444',
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: '#eee' }, title: { display: true, text: 'Shrink %' } },
            x: { grid: { color: '#eee' }, title: { display: true, text: 'Service Level' } }
          }
        }
      });
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    
    document.getElementById('slMean').addEventListener('input', runSimulation);
    document.getElementById('slStd').addEventListener('input', runSimulation);
    document.getElementById('deliveryFreq').addEventListener('input', runSimulation);
    document.getElementById('demandCV').addEventListener('input', runSimulation);
    document.getElementById('serviceLevel').addEventListener('input', runSimulation);

    // Initialize on load
    window.addEventListener('DOMContentLoaded', function() {
      initCharts();
      runSimulation();
    });
  </script>
</body>
</html>
